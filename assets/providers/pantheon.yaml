# Pantheon.io provider configuration.

# To use this configuration:
#
# 1. Get your Pantheon.io machine token:
#    a. Login to your Pantheon Dashboard, and [Generate a Machine Token](https://pantheon.io/docs/machine-tokens/) for ddev to use.
#    b. Add the API token to the `web_environment` section in your global ddev configuration at ~/.ddev/global_config.yaml:
#    ```yaml
#    web_environment:
#        - TERMINUS_MACHINE_TOKEN=abcdeyourtoken
#    ```
#    You can also do this with `ddev config global --web-environment-add="TERMINUS_MACHINE_TOKEN=abcdeyourtoken"`.
#
#    To use multiple API tokens for different projects, add them to your per-project configuration
#    using the .ddev/config.local.yaml file instead. This file is gitignored by default.
#    ```yaml
#    web_environment:
#        - TERMINUS_MACHINE_TOKEN=abcdeyourtoken
#    ```

auth_command:
  command: |
    set -eu -o pipefail
    if [ -z "${TERMINUS_MACHINE_TOKEN:-}" ]; then echo "Please make sure you have set TERMINUS_MACHINE_TOKEN in ~/.ddev/global_config.yaml" && exit 1; fi
    if [ -z "${PANTHEON_SITE:-}" ]; then echo "Please make sure you have set PANTHEON_SITE via config.yaml or with '--environment=PANTHEON_SITE=xxx'" && exit 1; fi
    terminus auth:login --machine-token="${TERMINUS_MACHINE_TOKEN}" || ( echo "terminus auth login failed, check your TERMINUS_MACHINE_TOKEN" && exit 1 )
    terminus aliases 2>/dev/null

db_pull_command:
  command: |
    # set -x   # You can enable bash debugging output by uncommenting
    set -eu -o pipefail
    ls /var/www/html/.ddev >/dev/null # This just refreshes stale NFS if possible

    if [ ${WORKING_ENVIRONMENT} == 'live' ]; then
      terminus ldb ${PANTHEON_SITE} --overwrite --yes
      # Gunzip works, but doesn't think it does, end silently.
      gunzip -q $HOME/pantheon-local-copies/db/${PANTHEON_SITE}-db.tgz | tar tvzf - &> /dev/null || true
      mv $HOME/pantheon-local-copies/db/${PANTHEON_SITE}-db.tar /var/www/html/.ddev/.downloads/db.sql
    else
      pushd /var/www/html/.ddev/.downloads >/dev/null
      connection=$(terminus connection:info ${PANTHEON_SITE}.${WORKING_ENVIRONMENT} --field='MySQL Command')
      connection=${connection/'mysql'/'mysqldump -v'}
      eval "$connection --single-transaction --default-character-set=utf8mb4 --quick | gzip > db.sql.gz"
    fi

files_pull_command:
  command: |
    # set -x   # You can enable bash debugging output by uncommenting
    set -eu -o pipefail
    pushd /var/www/html/.ddev/.downloads >/dev/null;
    terminus backup:get ${PANTHEON_SITE}.${WORKING_ENVIRONMENT} --element=files --to=files.tgz
    mkdir -p files && tar --strip-components=1 -C files -zxf files.tgz

# push is very useful for non-production environments, but can be
# very dangerous to production environments. If it is dangerous to your
# workflow you can remove the lines below and remove the `ddev-generated` in this file
db_push_command:
  command: |
    # set -x   # You can enable bash debugging output by uncommenting
    ssh-add -l >/dev/null || ( echo "Please 'ddev auth ssh' before running this command." && exit 1 )
    set -eu -o pipefail
    pushd /var/www/html/.ddev/.downloads >/dev/null;
    echo "Waking up Pantheon environment..."
    terminus env:wake -- ${PANTHEON_SITE}.${WORKING_ENVIRONMENT}
    echo "Dropping existing database on Pantheon..."
    MYSQL_CMD=$(terminus connection:info "${PANTHEON_SITE}.${WORKING_ENVIRONMENT}" --field=mysql_command)
    eval "$MYSQL_CMD -e 'DROP DATABASE pantheon; CREATE DATABASE pantheon;'"
    echo "Uploading database to Pantheon..."
    gzip -dc db.sql.gz | eval "$MYSQL_CMD"
    echo "Database push complete"

# push is very useful for non-production environments, but can be
# very dangerous to production environments. If it is dangerous to your
# workflow you can remove the lines below and remove the `ddev-generated` in this file
files_push_command:
  command: |
    # set -x   # You can enable bash debugging output by uncommenting
    ssh-add -l >/dev/null || ( echo "Please 'ddev auth ssh' before running this command." && exit 1 )
    set -eu -o pipefail
    ls ${DDEV_FILES_DIR} >/dev/null # This just refreshes stale NFS if possible
    terminus self:plugin:install terminus-rsync-plugin
    terminus rsync -y ${DDEV_FILES_DIR}/ ${PANTHEON_SITE}.${WORKING_ENVIRONMENT}:files
